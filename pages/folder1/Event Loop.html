<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>btqf-blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/egg.png">
    <meta name="description" content="btqf-blog">
    
    <link rel="preload" href="/assets/css/0.styles.6cf9dbb0.css" as="style"><link rel="preload" href="/assets/js/app.cffeba78.js" as="script"><link rel="preload" href="/assets/js/2.caeefc96.js" as="script"><link rel="preload" href="/assets/js/10.331726d5.js" as="script"><link rel="prefetch" href="/assets/js/11.b8da12f6.js"><link rel="prefetch" href="/assets/js/12.378c20c3.js"><link rel="prefetch" href="/assets/js/13.9b896285.js"><link rel="prefetch" href="/assets/js/14.94ea083e.js"><link rel="prefetch" href="/assets/js/15.ddb796d5.js"><link rel="prefetch" href="/assets/js/16.be6fa19f.js"><link rel="prefetch" href="/assets/js/17.6aa34787.js"><link rel="prefetch" href="/assets/js/18.9cb7157b.js"><link rel="prefetch" href="/assets/js/19.9d4ba711.js"><link rel="prefetch" href="/assets/js/20.e370eaa2.js"><link rel="prefetch" href="/assets/js/21.56c87e54.js"><link rel="prefetch" href="/assets/js/22.4c624b2c.js"><link rel="prefetch" href="/assets/js/23.90b4299c.js"><link rel="prefetch" href="/assets/js/24.69ede40f.js"><link rel="prefetch" href="/assets/js/25.a547a671.js"><link rel="prefetch" href="/assets/js/26.2e359fd5.js"><link rel="prefetch" href="/assets/js/27.dfe71320.js"><link rel="prefetch" href="/assets/js/28.259ce105.js"><link rel="prefetch" href="/assets/js/29.0eb49c4d.js"><link rel="prefetch" href="/assets/js/3.b69d01d7.js"><link rel="prefetch" href="/assets/js/30.f0c9c863.js"><link rel="prefetch" href="/assets/js/31.20174c1d.js"><link rel="prefetch" href="/assets/js/32.babe428d.js"><link rel="prefetch" href="/assets/js/33.10ec67d7.js"><link rel="prefetch" href="/assets/js/4.b536f15f.js"><link rel="prefetch" href="/assets/js/5.9fcc5445.js"><link rel="prefetch" href="/assets/js/6.e09b9b27.js"><link rel="prefetch" href="/assets/js/7.4a93e793.js"><link rel="prefetch" href="/assets/js/8.7a8bf80c.js"><link rel="prefetch" href="/assets/js/9.bdbaadcf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6cf9dbb0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/btqf.jpg" alt="btqf-blog" class="logo"> <span class="site-name can-hide">btqf-blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/folder1/HTML必知必会.html" class="nav-link">
  web前端必备
</a></li><li class="dropdown-item"><!----> <a href="/pages/folder2/test4.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/pages/folder3/冒泡排序.html" class="nav-link">
  数据结构算法
</a></li></ul></div></div><div class="nav-item"><a href="/pages/folder1/Event Loop.html" class="nav-link">
  功能演示
</a></div><div class="nav-item"><a href="https://github.com/btqf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/folder1/HTML必知必会.html" class="nav-link">
  web前端必备
</a></li><li class="dropdown-item"><!----> <a href="/pages/folder2/test4.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/pages/folder3/冒泡排序.html" class="nav-link">
  数据结构算法
</a></li></ul></div></div><div class="nav-item"><a href="/pages/folder1/Event Loop.html" class="nav-link">
  功能演示
</a></div><div class="nav-item"><a href="https://github.com/btqf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTML</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/folder1/HTML必知必会.html" class="sidebar-link">HTML必知必会</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/folder1/JS类型判断与转换.html" class="sidebar-link">类型判断与转换</a></li><li><a href="/pages/folder1/变量提升.html" class="sidebar-link">变量提升</a></li><li><a href="/pages/folder1/this指向.html" class="sidebar-link">this指向</a></li><li><a href="/pages/folder1/闭包.html" class="sidebar-link">闭包</a></li><li><a href="/pages/folder1/new运算符.html" class="sidebar-link">new操作符</a></li><li><a href="/pages/folder1/call &amp; apply &amp; bind.html" class="sidebar-link">call/apply/bind</a></li><li><a href="/pages/folder1/原型.html" class="sidebar-link">原型</a></li><li><a href="/pages/folder1/类.html" class="sidebar-link">Class</a></li><li><a href="/pages/folder1/继承.html" class="sidebar-link">继承</a></li><li><a href="/pages/folder1/模块化.html" class="sidebar-link">模块化</a></li><li><a href="/pages/folder1/异步编程.html" class="sidebar-link">异步编程</a></li><li><a href="/pages/folder1/Event Loop.html" class="active sidebar-link">Event Loop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_1-浏览器端event-loop" class="sidebar-link">1. 浏览器端Event Loop</a></li><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_2-node-js环境event-loop" class="sidebar-link">2. Node.js环境Event Loop</a></li><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_3、总结" class="sidebar-link">3、总结</a></li></ul></li><li><a href="/pages/folder1/节流函数和防抖函数.html" class="sidebar-link">节流防抖</a></li><li><a href="/pages/folder1/柯里化.html" class="sidebar-link">柯里化</a></li><li><a href="/pages/folder1/chrome v8的内存管理与垃圾回收.html" class="sidebar-link">内存管理与垃圾回收</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/folder1/Event Loop.html" class="active sidebar-link">React Hook</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_1-浏览器端event-loop" class="sidebar-link">1. 浏览器端Event Loop</a></li><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_2-node-js环境event-loop" class="sidebar-link">2. Node.js环境Event Loop</a></li><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_3、总结" class="sidebar-link">3、总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/folder1/Event Loop.html" class="active sidebar-link">Vue生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_1-浏览器端event-loop" class="sidebar-link">1. 浏览器端Event Loop</a></li><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_2-node-js环境event-loop" class="sidebar-link">2. Node.js环境Event Loop</a></li><li class="sidebar-sub-header"><a href="/pages/folder1/Event Loop.html#_3、总结" class="sidebar-link">3、总结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>我们都知道，<code>Event Loop</code>即事件循环，是指浏览器或<code>Node</code>的一种解决<code>JavaScript</code>单线程运行时不会阻塞的一种机制，即我们经常使用<strong>异步</strong>的原理。
而浏览器中的事件循环与<code>Node.js</code>事件循环机制各不相同。</p> <h2 id="_1-浏览器端event-loop"><a href="#_1-浏览器端event-loop" class="header-anchor">#</a> 1. 浏览器端Event Loop</h2> <h3 id="_1-1-我们为什么需要event-loop"><a href="#_1-1-我们为什么需要event-loop" class="header-anchor">#</a> 1.1 我们为什么需要Event Loop</h3> <p>在介绍<code>Event Loop</code>原理前，我们必须得要搞清楚为什么需要<code>Event Loop</code>?
<code>JavaScript</code>是一门单线程语言，当一个函数执行时，它不会被抢占，只有在它运行完毕后才会去运行任何其他的代码，才能去修改这个函数操作的数据。然而当一个消息需要太长时间才能处理完毕时，Web应用程序就无法处理与用户的交互，例如点击或滚动；又或者是浏览新闻时图片加载过慢，网页不可能一直卡着直到图片完全显示出来。为了解决这些问题，我们将任务分为了两类：同步任务与异步任务。
在异步任务中，**同一时间按照代码顺序等待执行。**通常我们在遇到异步代码时将其挂起并略过，等待同步代码执行完毕后按照特定顺序执行异步代码。接下来我们深入了解一下。</p> <h3 id="_1-2-javascript的运行模型"><a href="#_1-2-javascript的运行模型" class="header-anchor">#</a> 1.2 JavaScript的运行模型</h3> <p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/28976061/1659438972285-21e33437-379a-492e-b6e1-7dfd787231cc.jpeg" alt="">
如图所示，当遇到同步代码时会立即执行；而遇到异步代码时将其加入到工作线程中，等异步代码所需时间到达后将其加入到任务队列当中。当执行栈为空时，被处理的消息被移除队列，并作为输入参数来调用与之关联的函数。函数的处理会一直进行到执行栈再次为空为止；然后事件循环将会处理队列中的下一个消息。
说了这么多，还不如来一个实例更容易理解：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 输出 &quot;2&quot;，表示回调函数并没有在 500 毫秒之后立即执行</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Ran after &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;looped for 2 seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>输出结果如下：
:::info
looped for 2 seconds
Ran after 2 seconds
:::
上述的代码执行流程如下：</p> <ul><li>先将异步代码挂起，放在工作线程中；</li> <li>然后在运行同步代码<code>while</code>语句，等待间隔2秒；</li> <li>在500ms时，将异步任务加入任务队列中；到2秒时执行<code>console.log(&quot;looped for 2 seconds&quot;)</code>；</li> <li>此时执行栈为空，任务队列推送任务<code>setTimeout</code>给执行栈，开始执行。</li></ul> <p>相信通过上述的代码，大家对<code>Event Loop</code>有了基本的了解。同时我们从代码中也可以发现，函数<code>**setTimeout**</code>**中的时间值参数它代表的是消息被实际加入队列的最小延迟时间，而不是确切的等待时间。**如果任务队列中没有其他消息且栈为空，在该延迟时间过后消息会被立马处理；但如果有其他消息，<code>setTimeout</code>消息必须等待其他消息处理完。</p> <h3 id="_1-3-宏任务与微任务"><a href="#_1-3-宏任务与微任务" class="header-anchor">#</a> 1.3 宏任务与微任务</h3> <p>在ECMA标准升级后，将异步任务分为了微任务和宏任务。
<strong>宏任务</strong>：是JS中原始的异步任务，包括<code>setTimeout</code>、<code>setInterval</code>、<code>AJAX</code>等，在代码执行环境中按照同步代码的顺序，逐个进入工作线程挂起，再按照异步任务到达的时间节点，逐个进入异步任务队列，最终按照队列中的顺序进入函数执行栈执行。
<strong>微任务</strong>：每一个宏任务执行前，程序先检测是否有当次事件循环未执行的微任务，优先清空本次的微任务后，在执行下一个宏任务。<strong>每个宏任务内部可注册当次任务的微任务队列，在下一个宏任务执行前运行，微任务也是按照进入队列的顺序执行。<strong>包括<code>Promise</code>、<code>MutationObserve</code>等。
让我们先来看看两者的执行顺序：
<img src="https://cdn.nlark.com/yuque/0/2022/jpeg/28976061/1659510156327-fbcdc3ef-b613-4cf1-8d76-e51ace0a9d90.jpeg" alt="">
执行栈的执行完同步任务后，判断执行栈是否为空。若执行栈为空，则去检查</strong>微任务</strong>队列是否为空，如果为空则去执行<strong>宏任务</strong>，否则一次性执行完所有的微任务。
当<strong>宏任务</strong>执行完毕后，检查是否存在<strong>微任务</strong>队列是否为空。如果为空则继续执行下一个<strong>宏任务</strong>；否则去执行完所有的**微任务，<strong>然后再去执行</strong>宏任务，**如此循环。
举个例子：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>输出结果如下：
:::info
script start
async2 end
Promise
script end
async1 end
promise1
promise2
setTimeout
:::
在讲解之前，我们必须得要理解<code>async/await</code>在底层是转换成<code>promise</code>和<code>then</code>的回调函数。当我们使用<code>await</code>，解释器创建一个<code>promise</code>对象，然后把剩下的async函数操作放到<code>then</code>回调函数中。我们需要知道，在同一个上下文当中，总的执行顺序为<strong>同步代码 ——&gt; 微任务 ——&gt; 宏任务。</strong>
我相信，根据上面的讲述大家应该都能正确理解，这里就不过多讲解了。</p> <h2 id="_2-node-js环境event-loop"><a href="#_2-node-js环境event-loop" class="header-anchor">#</a> 2. Node.js环境Event Loop</h2> <h3 id="_2-1-执行流程"><a href="#_2-1-执行流程" class="header-anchor">#</a> 2.1 执行流程</h3> <p><code>Node.js</code>的<code>Event Loop</code>分为六个阶段，<strong>它们按照顺序反复执行，在每个阶段后面都会运行微任务队列</strong>。</p> <div class="language- extra-class"><pre><code>  - `timers`：执行`setTimeout()` 和 `setInterval()`中到期的callback。
  - `I/O callbacks`：上一轮循环中有少数的`I/Ocallback`会被延迟到这一轮的这一阶段执行
  - `idle, prepare`：队列的移动，仅内部使用
  - `poll`：最为重要的阶段，执行`I/O callback`，在适当的条件下会阻塞在这个阶段
  - `check`：执行`setImmediate`的callback	
  - `close callbacks`：执行close事件的callback，例如s`ocket.on(&quot;close&quot;,func)`
</code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/28976061/1659515991624-29013114-3c96-47f3-b846-11c8a9bb62c8.jpeg" alt=""></p> <h3 id="_2-2-settimeout-setimmediate"><a href="#_2-2-settimeout-setimmediate" class="header-anchor">#</a> 2.2 setTimeout/setImmediate</h3> <p>在运行过程中，如果<code>timers</code>阶段执行时创建了<code>setImmediate</code>，则会在此轮循环的<code>check</code>阶段中执行；如果<code>timers</code>阶段创建了<code>setTimeout</code>，此时由于<code>timers</code>已取出完毕，则会进入到下一轮循环。<code>check</code>阶段创建<code>timers</code>任务同理。
来个代码演示一下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 此时处在 I/O 周期</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language- extra-class"><pre><code>运行结果一定为`setImmediate &gt; setTimeout`, 因为在`I/O`阶段读取文件后进行到了`poll`阶段，然后到`check`阶段，此时会立刻执行`setImmediate`,等到进入`timers`阶段采取执行`setTimeout`。
</code></pre></div><h3 id="_2-3-process-nexttick"><a href="#_2-3-process-nexttick" class="header-anchor">#</a> 2.3 Process.nextTick()</h3> <p><code>process.nextTick()</code>将<code>callback</code>添加到<code>next tick</code>队列。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 输出结果：4 3 1 2或者4 3 2 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>从输出结果可以看到，微任务比宏任务先运行，而在<code>Node</code>中<code>process.nextTick</code>比<code>Promise</code>更为优先，所以输出结果4 —&gt; 3；但在<code>Node</code>中没有绝对意义上的0ms，所以<code>setTimeout</code>和<code>setImmediate</code>顺序不固定。</p> <h3 id="_2-4-浏览器与node执行顺序比较"><a href="#_2-4-浏览器与node执行顺序比较" class="header-anchor">#</a> 2.4 浏览器与Node执行顺序比较</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout1'</span><span class="token punctuation">)</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout2'</span><span class="token punctuation">)</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>输出结果如下：
:::info
在浏览器中：timeout1 —&gt; promise1 —&gt; timeout2 —&gt; promise2
在Node环境中： timeout1 —&gt; timeout2 —&gt; promise1 —&gt; promise2
:::
下面来解释一下Node环境中的逻辑：
开始时进入<code>timers</code>阶段，执行<code>timeout1</code>的回调，打印出<code>timeout1</code>后将<code>promise。then()</code>放入微任务队列中，相同步骤执行 <code>timeout2</code>。在<code>timers</code>阶段结束后进入下一个阶段前，执行微任务队列中的所有任务，依次打印出<code>promise1</code>、<code>promise2</code>.
浏览器的执行顺序就不过多讲述了。</p> <h2 id="_3、总结"><a href="#_3、总结" class="header-anchor">#</a> 3、总结</h2> <p>总体而言，浏览器端与Node.js的执行顺序大有不同。最大的差异在于浏览器端按照同步代码 —&gt;微任务 —&gt;宏任务的顺序执行；而Node.js环境中按照六个阶段顺序执行，且在每个阶段结束后都会执行微任务队列里的所有任务。</p> <p>本文就写到这里，如有错误，敬请指正！</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/folder1/异步编程.html" class="prev">
        异步编程
      </a></span> <span class="next"><a href="/pages/folder1/节流函数和防抖函数.html">
        节流防抖
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cffeba78.js" defer></script><script src="/assets/js/2.caeefc96.js" defer></script><script src="/assets/js/10.331726d5.js" defer></script>
  </body>
</html>
